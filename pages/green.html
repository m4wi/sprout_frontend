<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>GestiÃ³n de GreenPoints</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<script>
    // Habilitar modo oscuro por clase
    tailwind.config = {
        darkMode: 'class',
    }
</script>

<body
    class="flex flex-col min-h-screen font-sans bg-white text-green-900 dark:bg-gray-900 dark:text-green-200 transition-colors duration-300">

    <!-- Fondo oscuro (debe estar aquÃ­ dentro del body, no afuera) -->
    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
    </div>


    <!-- Modal Login -->
    <div id="modal-login" class="hidden fixed inset-0 flex items-center justify-center z-[99999]">
        <div class="bg-white w-96 p-6 rounded shadow-lg relative">
            <button onclick="cerrarModal('login')"
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">âœ–</button>
            <h2 class="text-2xl font-bold mb-4 text-green-600">Iniciar SesiÃ³n</h2>

            <form id="form-login" class="space-y-4">
                <input type="text" name="username" placeholder="Usuario o Email" class="w-full border rounded px-3 py-2"
                    required>
                <input type="password" name="password" placeholder="ContraseÃ±a" class="w-full border rounded px-3 py-2"
                    required>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                    Entrar
                </button>
            </form>

            <div id="loginMsg" class="mt-3 text-center text-sm"></div>

            <div class="mt-4">
                <button onclick="entrarInvitado()"
                    class="w-full bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300">
                    Entrar como Invitado
                </button>
            </div>

            <p class="text-sm mt-4 text-gray-600">
                Â¿No tienes cuenta?
                <button onclick="cambiarModal('login','register')" class="text-green-600 hover:underline">
                    RegÃ­strate
                </button>
            </p>
        </div>
    </div>

    <!-- Modal Registro -->
    <div id="modal-register" class="hidden fixed inset-0 flex items-center justify-center z-[9999]">
        <div class="bg-white w-96 p-6 rounded shadow-lg relative">
            <button onclick="cerrarModal('register')"
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">âœ–</button>
            <h2 class="text-2xl font-bold mb-4 text-green-600">Crear Cuenta</h2>

            <form id="form-register" class="space-y-4">
                <input type="text" name="username" placeholder="Usuario" class="w-full border rounded px-3 py-2"
                    required>
                <input type="email" name="email" placeholder="Correo electrÃ³nico"
                    class="w-full border rounded px-3 py-2" required>
                <input type="password" name="password" placeholder="ContraseÃ±a" class="w-full border rounded px-3 py-2"
                    required>
                <select name="tipo" class="w-full border rounded px-3 py-2" required>
                    <option value="">-- Tipo de usuario --</option>
                    <option value="ciudadano">Ciudadano</option>
                    <option value="recolector">Recolector</option>
                    <option value="centro">Centro</option>
                </select>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                    Registrarse
                </button>
            </form>

            <div id="registerMsg" class="mt-3 text-center text-sm"></div>

            <p class="text-sm mt-4 text-gray-600">
                Â¿Ya tienes cuenta?
                <button onclick="cambiarModal('register','login')" class="text-green-600 hover:underline">
                    Inicia sesiÃ³n
                </button>
            </p>
        </div>
    </div>

    <div class="p-4">
        <!-- HEADER SECTION -->
        <header class="
               bg-white/90 dark:bg-gray-900/80 backdrop-blur-md 
               text-gray-800 dark:text-gray-100 
               rounded-3xl shadow-xl px-6 py-4 
               flex justify-between items-center 
               font-sans tracking-wide z-50">

            <!-- Logo + tÃ­tulo -->
            <div class="flex items-center gap-3">
                <img src="../assets/soybean.svg" alt="GreenPoints Logo" class="w-10 h-10 rounded-full">
                <span class="text-xl font-bold text-[#c7bda9] dark:text-green-400">
                    Sprouts
                </span>
            </div>

            <!-- Nav principal -->
            <nav class="flex gap-6 text-sm font-medium">
                <a href="index.html" class="hover:text-[#075330] dark:hover:text-green-400 transition">mapa</a>
                <a href="green.html" class="hover:text-[#075330] dark:hover:text-green-400 transition">mis
                    greenpoints</a>
                <a href="perfil.html" class="hover:text-[#075330] dark:hover:text-green-400 transition">perfil</a>
            </nav>

            <!-- Botones -->
            <div class="flex gap-3 items-center">
                <!-- Switch theme -->
                <button id="themeToggle" class="px-3 py-2 bg-[#075330] text-white text-sm rounded-full shadow-md 
                   hover:bg-[#064127] transition">
                    ðŸŒž/ðŸŒ™
                </button>
                <!-- Auth -->
                <div id="auth-buttons" class="flex gap-3 items-center">
                    <button onclick="abrirModal('login')" class="px-4 py-2 bg-white text-[#075330] font-semibold rounded-lg shadow 
                        hover:bg-gray-100 dark:bg-gray-700 dark:text-green-200 dark:hover:bg-gray-600 transition">
                        login
                    </button>
                    <button onclick="abrirModal('register')" class="px-4 py-2 bg-yellow-400 text-green-900 font-semibold rounded-lg shadow 
                        hover:bg-yellow-300 dark:bg-yellow-500 dark:text-gray-900 transition">
                        signup
                    </button>
                </div>

                <!-- Usuario logueado -->
                <div id="user-info" class="hidden flex items-center gap-3">
                    <span id="user-name" class="font-semibold text-[#075330] dark:text-green-200"></span>
                    <button onclick="cerrarSesion()"
                        class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Salir</button>
                </div>
            </div>
        </header>
    </div>

    <main class="flex-1 p-6 flex gap-12 min-h-0">
        <div class="grid grid-cols-3 gap-6">
            <!-- Columna izquierda -->
            <div class="space-y-6">
                <!-- Lista principal -->
                <div>
                    <h2 class="text-xl font-semibold text-green-600 mb-4">Activos</h2>
                    <div id="lista-activos" class="space-y-4"></div>
                </div>

                <!-- Lista secundaria -->
                <div>
                    <h2 class="text-xl font-semibold text-green-600 mb-4">Finalizados</h2>
                    <div id="lista-finalizados" class="space-y-4"></div>
                </div>
            </div>

            <!-- Columna derecha (detalles) -->
            <div class="col-span-2">
                <h2 class="text-xl font-semibold text-green-600 mb-4">Detalles</h2>
                <div id="detalles" class="bg-white p-6 rounded-xl shadow text-gray-700 h-full">
                    <p class="text-gray-400">Selecciona un GreenPoint para ver detalles.</p>
                </div>
                <!--- AGREGA EL CHA AQUI-->
            </div>
        </div>

        <!-- Modal de ediciÃ³n -->
        <div id="modal-editar"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white w-96 p-6 rounded-xl shadow-lg relative">
                <button onclick="cerrarModal()"
                    class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">âœ–</button>
                <h2 class="text-xl font-bold text-green-700 mb-4">Editar GreenPoint</h2>
                <form id="form-editar" class="space-y-4">
                    <input type="text" id="editar-nombre" placeholder="Nombre del GreenPoint"
                        class="w-full px-3 py-2 border rounded-lg" required>
                    <textarea id="editar-descripcion" placeholder="DescripciÃ³n"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>

                    <!-- Coord separados -->
                    <input type="number" step="any" id="editar-lat" placeholder="Latitud"
                        class="w-full px-3 py-2 border rounded-lg" required>
                    <input type="number" step="any" id="editar-lng" placeholder="Longitud"
                        class="w-full px-3 py-2 border rounded-lg" required>

                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Guardar
                        Cambios</button>
                </form>
            </div>
        </div>
    </main>
    <footer class="bg-[#c7bda9] text-white dark:bg-green-500 mt-8">
        <div class="max-w-6xl mx-auto px-6 py-6 flex flex-col md:flex-row justify-between items-center gap-4">

            <!-- Info -->
            <p class="text-sm text-center md:text-left">
                Â© 2025 GreenPoints. Todos los derechos reservados.
            </p>

            <!-- Links -->
            <nav class="flex gap-6 text-sm">
                <a href="about.html" class="hover:underline">Acerca</a>
                <a href="contact.html" class="hover:underline">Contacto</a>
                <a href="privacy.html" class="hover:underline">Privacidad</a>
            </nav>

        </div>
    </footer>
    <script src="../js/onload.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const token = localStorage.getItem("token"); // JWT
        const listaActivos = document.getElementById("lista-activos");
        const listaFinalizados = document.getElementById("lista-finalizados");
        const detallesDiv = document.getElementById("detalles");

        let greenpoints = [];
        let editarId = null;

        // --- FunciÃ³n para obtener GreenPoints del usuario ---
        async function fetchGreenPoints() {
            try {
                const res = await fetch("http://localhost:3000/greenpoints/mine", {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Error al obtener GreenPoints");
                greenpoints = await res.json();
                render();
            } catch (err) {
                console.error(err);
            }
        }

        // --- Renderizar lista ---
        function render() {
            listaActivos.innerHTML = "";
            listaFinalizados.innerHTML = "";
            detallesDiv.innerHTML = `<p class="text-gray-400">Selecciona un GreenPoint para ver detalles.</p>`;

            greenpoints.forEach(gp => {
                const card = document.createElement("div");
                card.className = "bg-white rounded-xl shadow p-4 flex justify-between items-center";

                const info = document.createElement("div");
                info.innerHTML = `
          <h3 class="text-lg font-semibold text-green-700">${gp.descripcion}</h3>
          <p class="text-sm text-gray-500">Estado: <span class="font-medium">${gp.estado}</span></p>
          <p class="text-sm text-gray-400">Fecha: ${new Date(gp.fecha_publicacion).toLocaleDateString()}</p>
        `;

                const actions = document.createElement("div");
                actions.className = "flex gap-2";

                const btnDetalles = document.createElement("button");
                btnDetalles.textContent = "Detalles";
                btnDetalles.className = "text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700";
                btnDetalles.onclick = () => mostrarDetalles(gp);
                actions.appendChild(btnDetalles);

                const btnEditar = document.createElement("button");
                btnEditar.textContent = "Editar";
                btnEditar.className = "text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600";
                btnEditar.onclick = () => abrirModalEditar(gp);
                actions.appendChild(btnEditar);

                if (gp.estado === "pendiente" || gp.estado === "en_proceso") {
                    const btnCancelar = document.createElement("button");
                    btnCancelar.textContent = "Cancelar";
                    btnCancelar.className = "text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600";
                    btnCancelar.onclick = () => actualizarEstado(gp.id_greenpoint, "finalizado");
                    actions.appendChild(btnCancelar);
                    listaActivos.appendChild(card);
                } else {
                    const btnEliminar = document.createElement("button");
                    btnEliminar.innerHTML = "ðŸ—‘ï¸";
                    btnEliminar.className = "text-sm bg-gray-300 px-2 py-1 rounded hover:bg-gray-400";
                    btnEliminar.onclick = () => eliminarGreenPoint(gp.id_greenpoint);
                    actions.appendChild(btnEliminar);
                    listaFinalizados.appendChild(card);
                }

                card.appendChild(info);
                card.appendChild(actions);
            });
        }

        // --- Mostrar detalles ---
        function mostrarDetalles(gp) {
            detallesDiv.innerHTML = `
        <h3 class="text-2xl font-semibold text-green-700 mb-2">${gp.descripcion}</h3>
        <p><span class="font-medium">Estado:</span> ${gp.estado}</p>
        <p><span class="font-medium">Fecha:</span> ${new Date(gp.fecha_publicacion).toLocaleDateString()}</p>
        <h4 class="font-semibold mt-3 mb-1">Materiales:</h4>
        <ul class="list-disc ml-6">
          ${gp.materials.map(m => `<li>${m.nombre} - ${m.cantidad}</li>`).join("")}
        </ul>
      `;
        }

        function abrirModalEditar(gp) {
            editarId = gp.id_greenpoint;
            document.getElementById("editar-nombre").value = gp.name;
            document.getElementById("editar-descripcion").value = gp.descripcion || "";
            document.getElementById("editar-lat").value = gp.coord.x;
            document.getElementById("editar-lng").value = gp.coord.y;
            document.getElementById("modal-editar").classList.remove("hidden");
        }

        document.getElementById("form-editar").addEventListener("submit", async (e) => {
            e.preventDefault();
            const nombre = document.getElementById("editar-nombre").value;
            const descripcion = document.getElementById("editar-descripcion").value;
            const lat = parseFloat(document.getElementById("editar-lat").value);
            const lng = parseFloat(document.getElementById("editar-lng").value);

            try {
                const res = await fetch(`http://localhost:3000/greenpoints/${editarId}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: nombre,
                        descripcion,
                        coord: [lat, lng]
                    })
                });
                if (!res.ok) throw new Error("Error al actualizar GreenPoint");
                cerrarModal();
                fetchGreenPoints();
            } catch (err) {
                console.error(err);
            }
        });

        function cerrarModal() {
            document.getElementById("modal-editar").classList.add("hidden");
            editarId = null;
        }

        // --- Actualizar estado ---
        async function actualizarEstado(id, estado) {
            try {
                const res = await fetch(`http://localhost:3000/greenpoints/${id}/estado`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ estado })
                });
                if (!res.ok) throw new Error("Error al actualizar estado");
                fetchGreenPoints();
            } catch (err) {
                console.error(err);
            }
        }

        // --- Eliminar GreenPoint ---
        async function eliminarGreenPoint(id) {
            try {
                const res = await fetch(`http://localhost:3000/greenpoints/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Error al eliminar");
                fetchGreenPoints();
            } catch (err) {
                console.error(err);
            }
        }

        fetchGreenPoints();
    </script>
</body>

</html>